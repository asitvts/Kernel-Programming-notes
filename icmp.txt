
## 1️⃣ ICMPv4 Basics

**ICMPv4 (Internet Control Message Protocol version 4)** is part of the **IP suite**, used mainly for:

1. **Error messages** – To report problems in delivering packets

   * Example: `Destination Unreachable`, `Time Exceeded`
2. **Information / query messages** – For diagnostics

   * Example: `Echo Request`, `Echo Reply`

**Reference:** RFC 1812 calls the information messages **query messages**.

**Kernel location:**

```text
net/ipv4/icmp.c
```

> Note: ICMPv4 cannot be built as a loadable kernel module; it’s compiled into the kernel.

---

## 2️⃣ Ping Utility

* **Purpose:** Check if a host is alive.
* **Mechanism:**

  1. Ping is a **userspace tool** (`iputils` package).
  2. Opens a **raw socket**.
  3. Sends an **ICMP_ECHO request**.
  4. Waits for an **ICMP_ECHO_REPLY**.

**Kernel side:**

* ICMP messages are processed in `net/ipv4/icmp.c`.
* The kernel handles **echo requests** and generates **echo replies**.

**Key point:** Ping itself is userspace; the ICMP processing is in the kernel.

---

## 3️⃣ Traceroute Utility

* **Purpose:** Find the path (hops) from source to destination.

* **Mechanism:**

  1. Sends packets (UDP by default) with **TTL starting from 1**.
  2. Each router **decrements TTL by 1**.
  3. When TTL reaches 0 at a router:

     * Router sends back **ICMP_TIME_EXCEEDED** message.
  4. Traceroute increases TTL by 1 and sends again.
  5. Repeats until **destination sends ICMP_ECHO_REPLY** (or UDP port unreachable).

* **Kernel processing:**

  * TTL decrement happens in IP layer.
  * ICMP “Time Exceeded” generated in `net/ipv4/icmp.c` by the kernel.

**Example Flow:**

| Step | TTL | Response                           |
| ---- | --- | ---------------------------------- |
| 1    | 1   | ICMP_TIME_EXCEEDED from 1st router |
| 2    | 2   | ICMP_TIME_EXCEEDED from 2nd router |
| …    | …   | …                                  |
| n    | n   | ICMP_ECHO_REPLY from destination   |

---

## 4️⃣ ICMP Messages Used in Ping/Traceroute

| Tool       | ICMP Type Used                      | Description               |
| ---------- | ----------------------------------- | ------------------------- |
| Ping       | ICMP_ECHO (request), ICMP_ECHOREPLY | Test if host is reachable |
| Traceroute | ICMP_TIME_EXCEEDED, ICMP_ECHO_REPLY | Trace path by hop count   |

**Important:** Traceroute sends **UDP by default**, but still relies on **ICMP replies** to determine path.

















The following are the most important things to know about ICMPv4, drawing solely on the sources provided:

### 1. Core Purpose and Categories

*   **Mandatory Protocol:** ICMPv4 is crucial for assuring correct system behavior by enabling feedback and diagnostics about problems in the communication environment.
*   **Categories:** ICMPv4 messages are classified into two main groups:
    *   **Error Messages** (e.g., Destination Unreachable, Time Exceeded).
    *   **Information/Query Messages** (e.g., Echo Request/Reply).

### 2. Header Structure

The ICMPv4 header begins with fixed fields followed by a variable portion:

*   **Type** (8 bits).
*   **Code** (8 bits).
*   **Checksum** (16 bits).
*   **Variable part** (32 bits), whose content changes based on the Type and Code.

Following the header is the **payload**, which typically includes the **IPv4 header of the originating packet** and a portion of its original payload.

### 3. Key Message Types and Uses

ICMPv4 is used as the underlying protocol for essential network diagnostics and error handling:

*   **Echo Request/Reply (Ping):** The popular `ping` utility sends an `ICMP_ECHO` request message and expects an `ICMP_REPLY` message in response. The kernel handles requests (`ICMP_ECHO`) using the `icmp_echo()` method, which sends a reply via `icmp_reply()`.
*   **Time Exceeded (`ICMP_TIME_EXCEEDED`):** This message is crucial for troubleshooting routing loops.
    *   If a packet being forwarded has its **Time To Live (TTL)** field decremented to 0, it is dropped, and an `ICMP_TIME_EXCEEDED` message with code `ICMP_EXC_TTL` is sent back.
    *   This mechanism is leveraged by the **`traceroute` utility** to discover the path between hosts by manipulating the packet's TTL.
    *   It is also sent when a fragmented packet timeout occurs (`ICMP_EXC_FRAGTIME` code).

### 4. Destination Unreachable Messages (ICMP\_DEST\_UNREACH)

This category includes several specific error codes sent when a destination cannot be reached:

| Code | Kernel Symbol | Trigger |
| :--- | :--- | :--- |
| **2** | `ICMP_PROT_UNREACH` | Sent back when the L4 protocol number specified in the IP header is nonexistent or unregistered in the kernel. |
| **3** | `ICMP_PORT_UNREACH` | Sent back if a UDPv4 packet arrives but no matching local socket is found listening on the destination port. |
| **4** | `ICMP_FRAG_NEEDED` | Sent when a packet must be forwarded but is larger than the outgoing link's MTU and the Don't Fragment (DF) bit is set. This informs the sender about the Path MTU (PMTU). |
| **5** | `ICMP_SR_FAILED` | Sent if a packet is being forwarded with the strict routing option set, but the route requires using a gateway. |

### 5. ICMP Redirects

*   **Purpose:** An `ICMP_REDIRECT` message is sent by a gateway (router) to advise the host that a suboptimal route is being used.
*   **Trigger:** A common condition for sending a Redirect message is that the input device and the output device for the packet are the same, suggesting the source should send directly to a different next hop.
*   **Mechanism:** When the packet is being forwarded, the `ip_forward()` method checks if the routing entry has the `RTCF_DOREDIRECT` flag set, and if so, calls `ip_rt_send_redirect()` to send the redirect message back to the sender.

### 6. Security and Control Features

*   **Rate Limiting:** The kernel supports rate limiting for sending ICMP packets (controlled by `sysctl_icmp_ratelimit` and `sysctl_icmp_ratemask`) to prevent abuse.
*   **Broadcast/Multicast Handling:** Incoming ICMP Echo (`ICMP_ECHO`) or Timestamp (`ICMP_TIMESTAMP`) messages destined for an IP broadcast or IP multicast address may be silently discarded, which is controlled by the `sysctl_icmp_echo_ignore_broadcasts` variable (default value is 1).
*   **Denial of Service (DoS):** ICMP is known to be used for security attacks, such as the Smurf Attack.
*   **User Configuration (iptables):** The `iptables` userspace tool allows using the `-j REJECT` target with the `--reject-with` qualifier to send specific ICMPv4 "Destination Unreachable" messages in response to blocked traffic (e.g., `icmp-host-prohibited`).

### 7. ICMP Sockets

ICMP Sockets (or "Ping Sockets") were integrated into the Linux kernel in version 3.0 to enable non-privileged applications (setuid-less) to use the ICMP protocol.

*   This allows a userspace application to create an ICMPv4 ping socket using `socket(PF_INET, SOCK_DGRAM, PROT_ICMP)`, rather than requiring a raw socket (`SOCK_RAW`).
*   ICMP sockets support only `ICMP_ECHO` requests with code 0.
*   The use of ICMP sockets is disabled by default and controlled via the `/proc/sys/net/ipv4/ping_group_range` procfs entry.

ICMPv4's role is largely focused on error messaging and diagnostics, in contrast to ICMPv6, which encompasses numerous additional functions like Neighbour Discovery (ND) and Multicast Listener Discovery (MLD), replacing protocols that remain separate in IPv4 (ARP and IGMP, respectively).

