

## 1. **Purpose of likely/unlikely macros**

Modern CPUs try to **predict which branch of a conditional will be taken**. If the CPU guesses wrong, it wastes cycles due to **branch misprediction**.

The **Linux kernel** defines two macros to help the compiler:

```c
#define likely(x)   __builtin_expect(!!(x), 1)
#define unlikely(x) __builtin_expect(!!(x), 0)
```

### Explanation:

* `x` â†’ the condition you want to test.
* `!!(x)` â†’ converts any value to a boolean (`0` or `1`).
* `__builtin_expect(expr, value)` â†’ a GCC compiler intrinsic:

  * Tells the compiler that `expr` is **likely equal to `value`**.
  * `1` = true, `0` = false.

So:

* `likely(x)` â†’ compiler assumes `x` is **usually true**.
* `unlikely(x)` â†’ compiler assumes `x` is **usually false**.

---

## 2. **How it affects compilation**

The compiler can **reorder code** or **optimize branch prediction hints** using these macros.

Example:

```c
if (likely(ptr != NULL)) {
    // This path is expected most of the time
    do_something(ptr);
} else {
    // Rare error path
    handle_error();
}
```

Without `likely`:

* Compiler treats both branches equally.
* CPU might mispredict if one path is rarely taken.

With `likely`:

* Compiler can generate code that favors the common path.
* Reduces CPU pipeline stalls.

Similarly:

```c
if (unlikely(error_occurred)) {
    printk("Unexpected error!\n");
}
```

* Marks this branch as rare.
* Optimizes for the non-error path.

---

## 3. **Performance impact**

* **Minor in many cases**, but in kernel code or tight loops, branch prediction can significantly affect performance.
* Often used in:

  * Error handling paths
  * Boundary checks
  * Rare conditions in networking, file I/O, etc.

---

## 4. **Example in kernel code**

From Linux kernel sources:

```c
int foo(int val)
{
    if (unlikely(val < 0)) {
        return -EINVAL; // rare error
    }

    return val * 2; // common case
}
```

* Here, `val < 0` is rare.
* The compiler will optimize `val >= 0` as the main path, making the common case faster.

---

### Summary Table

| Macro         | Meaning                     | Compiler Hint           |
| ------------- | --------------------------- | ----------------------- |
| `likely(x)`   | `x` is expected to be true  | Branch is usually taken |
| `unlikely(x)` | `x` is expected to be false | Branch is rarely taken  |

---

ðŸ’¡ **Tip:**
You should only use `likely`/`unlikely` **when you know the condition frequency**. Misusing them can make the code slower.

---


